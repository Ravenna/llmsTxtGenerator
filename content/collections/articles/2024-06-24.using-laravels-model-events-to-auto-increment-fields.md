---
id: 40604f94-8689-46b7-a2e8-52daad605e19
blueprint: article
title: "Using Laravel's Model Events to Auto-increment Fields"
author: 0f0756d9-2088-41aa-94cf-4307d8462ba6
categories:
  - development
tags:
  - code
  - laravel
  - tutorial
background_image: jukan-tateisi-bjht_8nbua0-unsplash.webp
photo_by: 'https://unsplash.com/@tateisimikito'
photo_by_text: 'Photo by Jukan Tateisi on Unsplash'
thumbnail: laravel-php-framework-for-replacing-legacy-systems.webp
seo:
  title: '@seo:title'
  image: '@seo:social_share_image'
updated_by: 1d1068ab-208d-480d-a677-dda65fe0f490
updated_at: 1719243176
content:
  -
    type: heading
    attrs:
      level: 4
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'When your auto-incrementing needs extend beyond the database defaults, reach for model events.'
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: 'Auto-incrementing is easy… right? It certainly should be. Chances are your database of choice auto-increments by default on primary keys and by choice on any integer field you want. Ok cool. Article over?'
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: 'Not even close. Sprinkle just the tiniest bit of complexity on top, and database defaults are out the door. What if you want to auto-increment but include an additional field as a parameter? Let’s take a real-world example: incrementing invoice numbers by company. Company A can have invoice number 1, and Company 2 can have invoice number 1. We can enforce uniqueness on the two fields, but can we auto-increment?'
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: 'Sadly, common database solutions will just shake their heads at you here. You gotta roll your own solution, champ. Thankfully, with Laravel, rolling our own solution is a piece of cake.'
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: 'Let’s stick with the invoice example. Let’s assume an invoice will always be attached to a company. What are some things we’d want from our auto-incrementing solution?'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              class: null
            content:
              -
                type: text
                text: "We want the app to take care of the logic for us, to rely on it the same way we’d rely on a MySql auto-increment or something similar.\_"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              class: null
            content:
              -
                type: text
                text: "We want this logic to run whenever a new invoice is created or is about to be created.\_"
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: 'We might want other niceties, like prefixing 0s to very small invoice numbers. We’ll worry about those later. To satisfy the most important requirements, we will reach for model events.'
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://laravel.com/docs/11.x/eloquent#events'
              rel: null
              target: null
              title: null
          -
            type: underline
        text: 'Model events'
      -
        type: text
        text: " have been around in Laravel for a long time. They are essentially ways to hook into a model's lifecycle, from creation to deletion. We are going to hook into the creating event to handle our auto-incrementing."
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: 'You can listen and respond to these events with your own event classes, but we will use closures in this example. To utilize closures for responding to model events, define them in the models’ booted method:'
  -
    type: set
    attrs:
      id: lxt4t8zc
      values:
        type: code
        inline_code:
          code: |
            namespace App\Models;

            class Invoice extends Model
            {
               protected static function booted():void
               {
                   static::created(function (Invoice $invoice){
                       //...
                   })
               }
            }
          mode: php
  -
    type: paragraph
    attrs:
      class: null
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: 'By defining a static created function, we will hook into any creation of this model, whether through a factory, in-app, or anywhere Eloquent is used to create an invoice. Pretty neat!'
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: 'The closure we provide is going to receive a specific invoice. In this case, one that is about to be saved. We can interrupt this process to determine what the next invoice number should be:'
  -
    type: set
    attrs:
      id: lxt4trh2
      values:
        type: code
        inline_code:
          code: |-
            namespace App\Models;

            class Invoice extends Model
            {
               protected static function booted():void
               {
                   static::created(function (Invoice $invoice){
                       // Get the last invoice for this company
                       $lastInvoice = Invoice::where('company_id', '=', $invoice->company_id)
                           ->select('invoice_number')
                           ->last();

                       // Handle no previous invoice
                       if (!$lastInvoice) {
                           $invoice->invoice_number = 1;
                       } else {
                           $invoice->invoice_number = $lastInvoice->invoice_number + 1;
                       }
                   })
               }
            }
          mode: htmlmixed
  -
    type: paragraph
    attrs:
      class: null
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: 'Technically, we are done. This little code will handle auto-incrementing for us, with a minuscule DB lookup per invoice created. Pretty great, right?'
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: "We can go a bit further, though. What if this is the only code we want to use to set the invoice number to avoid collisions? Let’s define a mutator for our invoices but prevent setting the invoice number altogether.\_"
  -
    type: set
    attrs:
      id: lxt4ukvx
      values:
        type: code
        inline_code:
          code: |
            namespace App\Models;

            use Illuminate\Database\Eloquent\Casts\Attribute;

            class Invoice extends Model
            {
               // Event closure up here
               public function invoiceNumber(): Attribute
               {
                   return Attribute::make(
                       set: fn($value) => throw new \Exception('Invoice number is read-only')
                   );
               }
            }
          mode: htmlmixed
  -
    type: paragraph
    attrs:
      class: null
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: 'Sweet, now only our auto-incrementing solution can set the invoice number. Or can it? We’ve broken it with this new code because we are trying to set the invoice number on the invoice model in our creating closure, which will trigger this error. Not to worry, we can bypass the setter by using the DB facade:'
  -
    type: set
    attrs:
      id: lxt4v6zl
      values:
        type: code
        inline_code:
          code: |
            namespace App\Models;

            class Invoice extends Model
            {

               protected static function booted():void
               {
                   static::created(function (Invoice $invoice){
                       // Get the last invoice for this company
                       $lastInvoice = Invoice::where('company_id', '=', $invoice->company_id)
                           ->select('invoice_number')
                           ->last();

                       // Set up the query to update this invoice
                       $query = DB::table('invoices')->where('id', '=', $invoice->id);
                       // Handle no previous invoice
                       if (!$lastInvoice) {
                           $query->update(['invoice_number' => 1]);
                       } else {
                           $query->update(['invoice_number' => $lastInvoice->invoice_number +1]);
                       }
                   })
               }


               public function invoiceNumber(): Attribute
               {
                   return Attribute::make(
                       set: fn($value) => throw new \Exception('Invoice number is read-only')
                   );
               }
            }
          mode: htmlmixed
  -
    type: paragraph
    attrs:
      class: null
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: "Now, any attempt to use eloquent to set the invoice number will throw an error, but if we need to, we can bypass it with the DB facade. Nifty, but goes to show no solution is perfect. Documentation and training ensure unsuspecting developers do not break your business logic.\_"
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: 'If you wanted to hook into the creating event instead, you could change the update method to an insertion. Similarly, if you wanted to prefix the invoice numbers, as we mentioned earlier, you can define a get method in the accessor to prefix the integer with leading 0s. You would then need to bypass the accessor when incrementing the number in your event hook. Everything has tradeoffs, but with model events, you have a great foundation.'
  -
    type: paragraph
    attrs:
      class: null
    content:
      -
        type: text
        text: 'I hope this article was helpful. Happy developing out there!'
---
